import telebot
from datetime import datetime, timedelta
import time
from threading import Thread
import pytz
"""–°—Ç—Ä–æ–∫–∞ 1: import telebot
–ß—Ç–æ —ç—Ç–æ: –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Bot API.
–ó–∞—á–µ–º: –ò–º–µ–Ω–Ω–æ —ç—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç:
–°–æ–∑–¥–∞–≤–∞—Ç—å –±–æ—Ç–∞ (telebot.TeleBot(TOKEN))
–û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
–†–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
–°—Ç—Ä–æ–∫–∞ 2: from datetime import datetime, timedelta
–ß—Ç–æ —ç—Ç–æ: –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–µ–º.
–ó–∞—á–µ–º:
datetime ‚Äî –ø–æ–ª—É—á–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è, —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –¥–∞—Ç—ã
timedelta ‚Äî –ø—Ä–∏–±–∞–≤–ª—è—Ç—å/–≤—ã—á–∏—Ç–∞—Ç—å –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∑–∞ 10 –º–∏–Ω—É—Ç –¥–æ —É—Ä–æ–∫–∞")
–°—Ç—Ä–æ–∫–∞ 3: import time
–ß—Ç–æ —ç—Ç–æ: –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º (–ø–∞—É–∑—ã, –∑–∞–¥–µ—Ä–∂–∫–∏).
–ó–∞—á–µ–º: –ù—É–∂–µ–Ω –¥–ª—è —Ü–∏–∫–ª–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É, –Ω–µ –ø–æ—Ä–∞ –ª–∏ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å)
–°—Ç—Ä–æ–∫–∞ 4: from threading import Thread
–ß—Ç–æ —ç—Ç–æ: –ú–æ–¥—É–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤.
–ó–∞—á–µ–º: –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å –¥–≤–µ –≤–µ—â–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
–ü–æ—Ç–æ–∫ 1: –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
–ü–æ—Ç–æ–∫ 2: –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤—Ä–µ–º—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ–± —É—Ä–æ–∫–∞
–°—Ç—Ä–æ–∫–∞ 5: import pytz
–ß—Ç–æ —ç—Ç–æ: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏.
–ó–∞—á–µ–º: –ß—Ç–æ–±—ã –∑–Ω–∞—Ç—å —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –≤ –ú–æ—Å–∫–≤–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥—Ä—É–≥–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ."""

from bot.models import Student, GlobalLesson, PersonalLesson, AdminSettings

TOKEN = '8540461229:AAEY64b5fB0DkOoP96yS6DE9b4MHHmf0JIQ'
bot = telebot.TeleBot(TOKEN)

temp_data = {}
"""  –ß—Ç–æ —ç—Ç–æ?
–ü—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

python
temp_data = {}
–ó–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω?
–ü—Ä–µ–¥—Å—Ç–∞–≤—å –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º:

text
–ë–æ—Ç: –í–≤–µ–¥–∏ —Å–≤–æ–π –∫–ª–∞—Å—Å
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: 10
–ë–æ—Ç: –í—ã–±–µ—Ä–∏ –±—É–∫–≤—É
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ë
–ë–æ—Ç: –ì–æ—Ç–æ–≤–æ!
–ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –±—É–∫–≤—É, –±–æ—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø–æ–º–Ω–∏—Ç—å, —á—Ç–æ –∫–ª–∞—Å—Å —É–∂–µ 10. –ù–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–∞–Ω–æ ‚Äî –≤–¥—Ä—É–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç?

–í–æ—Ç —Ç—É—Ç –∏ –Ω—É–∂–µ–Ω temp_data!"""
MSK_TZ = pytz.timezone('Europe/Moscow')
# ============================================================================
# –¢–ï–õ–ï–ì–†–ê–ú-–ë–û–¢ –î–õ–Ø –®–ö–û–õ–¨–ù–û–ì–û –†–ê–°–ü–ò–°–ê–ù–ò–Ø
# ============================================================================
# –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞:
# - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–µ–Ω–∏–∫–æ–≤
# - –ü–æ–∫–∞–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (—Å–µ–≥–æ–¥–Ω—è, –∑–∞–≤—Ç—Ä–∞, –Ω–µ–¥–µ–ª—è)
# - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ–± —É—Ä–æ–∫–∞—Ö (—Ñ–æ–Ω–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏)
# - –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—á–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
# - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≥–ª–æ–±–∞–ª—å–Ω—ã–º –∏ –ª–∏—á–Ω—ã–º
# ============================================================================

import telebot                          # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è Telegram-–±–æ—Ç–æ–≤
                                        # –ü–æ–∑–≤–æ–ª—è–µ—Ç: –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏,
                                        # –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã, –ø–æ–ª—É—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

from datetime import datetime, timedelta # –†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
                                        # datetime - —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏
                                        # timedelta - —Ä–∞–∑–Ω–∏—Ü–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ (–¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π)

import time                             # –î–ª—è –ø–∞—É–∑ –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö (sleep)
                                        # –ß—Ç–æ–±—ã –ø–æ—Ç–æ–∫–∏ –Ω–µ –Ω–∞–≥—Ä—É–∂–∞–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏

from threading import Thread            # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
                                        # –ù—É–∂–Ω–æ —á—Ç–æ–±—ã –±–æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:
                                        # - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                                        # - –ø—Ä–æ–≤–µ—Ä—è–ª –≤—Ä–µ–º—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è

import pytz                             # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
                                        # –°–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –≥–¥–µ —É–≥–æ–¥–Ω–æ, –∞ —É—Ä–æ–∫–∏ –≤ –ú–æ—Å–∫–≤–µ

from bot.models import Student, GlobalLesson, PersonalLesson, AdminSettings  # –ù–∞—à–∏ –º–æ–¥–µ–ª–∏ Django
                                        # Student - —É—á–µ–Ω–∏–∫–∏
                                        # GlobalLesson - –æ–±—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–ª–∞—Å—Å–æ–≤
                                        # PersonalLesson - –ª–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—á–µ–Ω–∏–∫–æ–≤
                                        # AdminSettings - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∞ (–∫–æ–Ω—Ç–∞–∫—Ç—ã)

# ============================================================================
# –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
# ============================================================================

# –¢–û–ö–ï–ù –ë–û–¢–ê - –ø–æ–ª—É—á–∞–µ–º –æ—Ç @BotFather –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–æ—Ç–∞
# –í–ê–ñ–ù–û: –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —Ç–æ–∫–µ–Ω —Ö—Ä–∞–Ω—è—Ç –≤ .env —Ñ–∞–π–ª–µ –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!
TOKEN = '8540461229:...'

# –°–û–ó–î–ê–Å–ú –û–ë–™–ï–ö–¢ –ë–û–¢–ê
# –ß–µ—Ä–µ–∑ —ç—Ç—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã –∏ —Ç.–¥.
bot = telebot.TeleBot(TOKEN)

# –í–†–ï–ú–ï–ù–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ (–≤—ã–±–æ—Ä –∫–ª–∞—Å—Å–∞, —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏—á–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è)
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {user_id: {'step': 'waiting_grade', 'grade': 10, ...}}
temp_data = {}

# –ß–ê–°–û–í–û–ô –ü–û–Ø–° - –ú–æ—Å–∫–≤–∞
# –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º –±—É–¥—É—Ç –≤ —ç—Ç–æ–º –ø–æ—è—Å–µ
MSK_TZ = pytz.timezone('Europe/Moscow')

# –†–ê–°–ü–ò–°–ê–ù–ò–ï –ó–í–û–ù–ö–û–í
# –°–ª–æ–≤–∞—Ä—å: –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞ -> –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞
# –ù—É–∂–Ω–æ –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —É—Ä–æ–∫–æ–≤
# –§–æ—Ä–º–∞—Ç: LESSON_TIMES[1]["start"] = "08:00"
LESSON_TIMES = {
    1: {"start": "08:00", "end": "08:40"},   # –£—Ä–æ–∫ 1: —Å 8:00 –¥–æ 8:40
    2: {"start": "08:50", "end": "09:30"},   # –£—Ä–æ–∫ 2: —Å 8:50 –¥–æ 9:30
    3: {"start": "09:50", "end": "10:30"},   # –£—Ä–æ–∫ 3: —Å 9:50 –¥–æ 10:30
    4: {"start": "10:50", "end": "11:30"},   # –£—Ä–æ–∫ 4: —Å 10:50 –¥–æ 11:30
    5: {"start": "11:40", "end": "12:20"},   # –£—Ä–æ–∫ 5: —Å 11:40 –¥–æ 12:20
    6: {"start": "12:30", "end": "13:10"},   # –£—Ä–æ–∫ 6: —Å 12:30 –¥–æ 13:10
    7: {"start": "13:20", "end": "14:00"},   # –£—Ä–æ–∫ 7: —Å 13:20 –¥–æ 14:00
    8: {"start": "14:10", "end": "14:50"},   # –£—Ä–æ–∫ 8: —Å 14:10 –¥–æ 14:50
}

# –ó–ê –°–ö–û–õ–¨–ö–û –ú–ò–ù–£–¢ –î–û –£–†–û–ö–ê –ù–ê–ü–û–ú–ò–ù–ê–¢–¨
# –í—ã–Ω–µ—Å–µ–Ω–æ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É, —á—Ç–æ–±—ã –ª–µ–≥–∫–æ –º–µ–Ω—è—Ç—å
REMINDER_MINUTES = 10

# ============================================================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ============================================================================

def get_lesson_time(lesson_number):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è —É—Ä–æ–∫–∞ –ø–æ –µ–≥–æ –Ω–æ–º–µ—Ä—É.
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        lesson_number (int): –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞ (1-8)
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        tuple: (start_time, end_time) –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Å—Ç—Ä–æ–∫ "–ß–ß:–ú–ú"
               –ï—Å–ª–∏ —É—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω - ("??:??", "??:??")
    
    –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
        start, end = get_lesson_time(3)  # start = "09:50", end = "10:30"
    """
    lesson = LESSON_TIMES.get(lesson_number)  # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞—Ä—å (–∏–ª–∏ None)
    if lesson:
        return lesson["start"], lesson["end"]
    return "??:??", "??:??"  # –ó–∞–≥–ª—É—à–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏

def get_current_lesson_time():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è –∫–∞–∫ –æ–±—ä–µ–∫—Ç datetime.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        datetime: —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ MSK_TZ
    
    –ó–∞—á–µ–º –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:
        - –ï–¥–∏–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        - –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—Å—è —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å, –ø—Ä–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å
    """
    return datetime.now(MSK_TZ)

def normalize_letter(letter):
    """
    –ü—Ä–∏–≤–æ–¥–∏—Ç –±—É–∫–≤—É –∫–ª–∞—Å—Å–∞ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –≤–∏–¥—É –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å.
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        letter (str): –±—É–∫–≤–∞, –≤–≤–µ–¥—ë–Ω–Ω–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–º–æ–∂–µ—Ç –±—ã—Ç—å "–∞", " –ê", "A")
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        str –∏–ª–∏ None: –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –±—É–∫–≤—É ('–ê', '–ë', '–í', '–ì') –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–∞
    
    –ü—Ä–∏–º–µ—Ä:
        normalize_letter(" –∞")  # '–ê'
        normalize_letter("–î")   # None
    """
    if not letter:                    # –ï—Å–ª–∏ –ø—É—Å—Ç–æ
        return None
    letter = letter.upper().strip()    # –ó–∞–≥–ª–∞–≤–Ω—ã–µ –∏ —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
    return letter if letter in ['–ê', '–ë', '–í', '–ì'] else None  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å

def get_student_lessons(student, day_num):
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–µ–Ω—å.
    
    –õ–æ–≥–∏–∫–∞:
        1. –ï—Å–ª–∏ —É—á–µ–Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (use_global=True)
           –∏ —É –Ω–µ–≥–æ —É–∫–∞–∑–∞–Ω—ã –∫–ª–∞—Å—Å/–±—É–∫–≤–∞ - –∏—â–µ–º –≤ GlobalLesson
        2. –ï—Å–ª–∏ –Ω–∞—à–ª–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Ö
        3. –ï—Å–ª–∏ –Ω–µ—Ç (–∏–ª–∏ use_global=False) - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–∏—á–Ω—ã–µ —É—Ä–æ–∫–∏ –∏–∑ PersonalLesson
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        student (Student): –æ–±—ä–µ–∫—Ç —É—á–µ–Ω–∏–∫–∞
        day_num (int): –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (1-5)
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        tuple: (QuerySet, str) - —É—Ä–æ–∫–∏ –∏ —Ç–∏–ø ('global' –∏–ª–∏ 'personal')
    
    –ü—Ä–∏–º–µ—Ä:
        lessons, type = get_student_lessons(petya, 1)
        # lessons - —Å–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤ –ü–µ—Ç–∏ –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        # type - 'global' –∏–ª–∏ 'personal'
    """
    # –ï—Å–ª–∏ —É—á–µ–Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ —É –Ω–µ–≥–æ –µ—Å—Ç—å –∫–ª–∞—Å—Å/–±—É–∫–≤–∞
    if student.use_global and student.grade and student.letter:
        # –ò—â–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏
        lessons = GlobalLesson.objects.filter(
            grade=student.grade,
            letter=student.letter,
            day=day_num
        ).order_by('number')  # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–æ–º–µ—Ä—É —É—Ä–æ–∫–∞
        
        # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å –ø–æ–º–µ—Ç–∫–æ–π 'global'
        if lessons.exists():
            return lessons, 'global'
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º (–∏–ª–∏ use_global=False) - –±–µ—Ä—ë–º –ª–∏—á–Ω—ã–µ
    lessons = PersonalLesson.objects.filter(
        student=student,
        day=day_num
    ).order_by('number')
    return lessons, 'personal'  # –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ

def get_next_lesson(student, current_time):
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫ –¥–ª—è —É—á–µ–Ω–∏–∫–∞.
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        student (Student): –æ–±—ä–µ–∫—Ç —É—á–µ–Ω–∏–∫–∞
        current_time (datetime): —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        tuple: (lesson, start_time) - –æ–±—ä–µ–∫—Ç —É—Ä–æ–∫–∞ –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
               –∏–ª–∏ (None, None) –µ—Å–ª–∏ —É—Ä–æ–∫–æ–≤ –±–æ–ª—å—à–µ –Ω–µ—Ç
    
    –ü—Ä–∏–º–µ—Ä:
        next_lesson, start = get_next_lesson(petya, now)
        if next_lesson:
            print(f"–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫: {next_lesson.subject} –≤ {start}")
    """
    today_num = current_time.isoweekday()  # 1=–ø–Ω, 2=–≤—Ç, 3=—Å—Ä, 4=—á—Ç, 5=–ø—Ç, 6=—Å–±, 7=–≤—Å
    
    if today_num > 5:  # –ï—Å–ª–∏ –≤—ã—Ö–æ–¥–Ω–æ–π (—Å–± –∏–ª–∏ –≤—Å)
        return None, None
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É—Ä–æ–∫–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    lessons, lesson_type = get_student_lessons(student, today_num)
    current_time_str = current_time.strftime("%H:%M")  # –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞
    
    # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —É—Ä–æ–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
    for lesson in lessons:
        start_time, _ = get_lesson_time(lesson.number)  # –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —É—Ä–æ–∫–∞
        if start_time > current_time_str:  # –ï—Å–ª–∏ —É—Ä–æ–∫ –µ—â—ë –Ω–µ –Ω–∞—á–∞–ª—Å—è
            return lesson, start_time  # –≠—Ç–æ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫
    
    return None, None  # –£—Ä–æ–∫–æ–≤ –±–æ–ª—å—à–µ –Ω–µ—Ç

# ============================================================================
# –§–£–ù–ö–¶–ò–ò –°–û–ó–î–ê–ù–ò–Ø –ö–õ–ê–í–ò–ê–¢–£–†
# ============================================================================

def get_main_keyboard():
    """
    –°–æ–∑–¥–∞—ë—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        ReplyKeyboardMarkup: –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏:
            üìÖ –°–µ–≥–æ–¥–Ω—è, üìÜ –ó–∞–≤—Ç—Ä–∞, üìö –ù–µ–¥–µ–ª—è,
            ‚è∞ –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫, ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏, ‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    
    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
        bot.send_message(chat_id, text, reply_markup=get_main_keyboard())
    """
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    # resize_keyboard=True - –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞
    # row_width=2 - –≤ —Ä—è–¥—É –ø–æ 2 –∫–Ω–æ–ø–∫–∏
    
    # –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫–∏
    btn1 = telebot.types.KeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è")
    btn2 = telebot.types.KeyboardButton("üìÜ –ó–∞–≤—Ç—Ä–∞")
    btn3 = telebot.types.KeyboardButton("üìö –ù–µ–¥–µ–ª—è")
    btn4 = telebot.types.KeyboardButton("‚è∞ –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫")
    btn5 = telebot.types.KeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
    btn6 = telebot.types.KeyboardButton("‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    markup.add(btn1, btn2, btn3, btn4, btn5, btn6)
    return markup

def get_settings_keyboard(student):
    """
    –°–æ–∑–¥–∞—ë—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫.
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        student (Student): –æ–±—ä–µ–∫—Ç —É—á–µ–Ω–∏–∫–∞ (–Ω—É–∂–µ–Ω –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏)
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        ReplyKeyboardMarkup: –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    """
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=1)
    btn1 = telebot.types.KeyboardButton("üîÑ –°–º–µ–Ω–∏—Ç—å –∫–ª–∞—Å—Å")
    btn2 = telebot.types.KeyboardButton("üìã –¢–∏–ø —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è")
    btn3 = telebot.types.KeyboardButton("üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é")
    markup.add(btn1, btn2, btn3)
    return markup

def get_back_keyboard():
    """
    –°–æ–∑–¥–∞—ë—Ç –ø—Ä–æ—Å—Ç—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π "–ù–∞–∑–∞–¥".
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
        ReplyKeyboardMarkup: –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –≤–æ–∑–≤—Ä–∞—Ç–∞
    """
    markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add(telebot.types.KeyboardButton("üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"))
    return markup

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–û–ú–ê–ù–î–´ /start
# ============================================================================

@bot.message_handler(commands=['start'])
def start(message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start.
    
    –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
        1. –ü–æ–ª—É—á–∞–µ–º user_id –∏ –∏–º—è –∏–∑ Telegram
        2. –ò—â–µ–º —É—á–µ–Ω–∏–∫–∞ –≤ –ë–î –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ
        3. –ï—Å–ª–∏ —É—á–µ–Ω–∏–∫ –Ω–æ–≤—ã–π –∏–ª–∏ –Ω–µ—Ç –∫–ª–∞—Å—Å–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–ª–∞—Å—Å–∞
        4. –ò–Ω–∞—á–µ - —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        message (Message): –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Telegram
            - message.chat.id - ID —á–∞—Ç–∞ (–æ–Ω –∂–µ telegram_id —É—á–µ–Ω–∏–∫–∞)
            - message.from_user.first_name - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    user_id = message.chat.id
    name = message.from_user.first_name or "–£—á–µ–Ω–∏–∫"
    
    # –ò—â–µ–º —É—á–µ–Ω–∏–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ
    # get_or_create –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç (–æ–±—ä–µ–∫—Ç, created) –≥–¥–µ created - True –µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π
    student, created = Student.objects.get_or_create(
        telegram_id=user_id,
        defaults={'name': name}  # –≠—Ç–∏ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω—è—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
    )
    
    # –ï—Å–ª–∏ —É—á–µ–Ω–∏–∫ –Ω–æ–≤—ã–π –∏–ª–∏ —É –Ω–µ–≥–æ –µ—â—ë –Ω–µ—Ç –∫–ª–∞—Å—Å–∞
    if created or not student.grade:
        # –°–æ–∑–¥–∞—ë–º –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å —á–∏—Å–ª–∞–º–∏ 1-11
        markup = telebot.types.InlineKeyboardMarkup(row_width=4)
        for g in range(1, 12):
            markup.add(telebot.types.InlineKeyboardButton(
                str(g),  # –ß—Ç–æ –≤–∏–¥–Ω–æ –Ω–∞ –∫–Ω–æ–ø–∫–µ
                callback_data=f"grade_{g}"  # –ß—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ callback
            ))
        
        bot.send_message(
            message.chat.id,
            "üéì *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è!*\n\n"
            "–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ:\n"
            "‚úÖ –í—Å–µ–≥–¥–∞ –∑–Ω–∞—Ç—å —Å–≤–æ—ë —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n"
            "‚úÖ –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å —É—Ä–æ–∫–∏\n"
            "‚úÖ –ü–æ–ª—É—á–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\n\n"
            "üìö *–î–ª—è –Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Å–≤–æ–π –∫–ª–∞—Å—Å:*",
            parse_mode='Markdown',  # –†–∞–∑—Ä–µ—à–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
            reply_markup=markup
        )
    else:
        # –£—á–µ–Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å –∏ –∫–ª–∞—Å—Å —É–∫–∞–∑–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        show_main_menu(message, student)

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø –ü–û–ö–ê–ó–ê –ì–õ–ê–í–ù–û–ì–û –ú–ï–ù–Æ
# ============================================================================

def show_main_menu(message, student):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—á–µ–Ω–∏–∫–µ –∏ —Å–ª–µ–¥—É—é—â–µ–º —É—Ä–æ–∫–µ.
    
    –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
        message (Message): —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è chat.id
        student (Student): –æ–±—ä–µ–∫—Ç —É—á–µ–Ω–∏–∫–∞
    """
    class_info = f"{student.grade}{student.letter}"
    now = get_current_lesson_time()
    next_lesson, next_time = get_next_lesson(student, now)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    welcome_text = (
        f"üè† *–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*\n\n"
        f"üë§ *–£—á–µ–Ω–∏–∫:* {student.name}\n"
        f"üéì *–ö–ª–∞—Å—Å:* {class_info}\n"
        f"üìã *–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:* {'üåç –ì–ª–æ–±–∞–ª—å–Ω–æ–µ' if student.use_global else 'üë§ –õ–∏—á–Ω–æ–µ'}\n"
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ª–µ–¥—É—é—â–µ–º —É—Ä–æ–∫–µ
    if next_lesson:
        welcome_text += f"\n‚è∞ *–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫:*\nüìö {next_lesson.subject} –≤ {next_time}"
    else:
        if now.isoweekday() > 5:
            welcome_text += "\n\nüéâ *–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å!*"
        else:
            welcome_text += "\n\n‚ú® *–£—Ä–æ–∫–æ–≤ –±–æ–ª—å—à–µ –Ω–µ—Ç*"
    
    welcome_text += "\n\n*–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:*"
    
    bot.send_message(
        message.chat.id,
        welcome_text,
        parse_mode='Markdown',
        reply_markup=get_main_keyboard()
    )

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò "–ù–ê–ó–ê–î –í –ú–ï–ù–Æ"
# ============================================================================

@bot.message_handler(func=lambda message: message.text == "üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é")
def back_to_menu(message):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é".
    –ü—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
    """
    user_id = message.chat.id
    try:
        student = Student.objects.get(telegram_id=user_id)
        show_main_menu(message, student)
    except Student.DoesNotExist:
        # –ï—Å–ª–∏ —É—á–µ–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω (—Å—Ç—Ä–∞–Ω–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è) - –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ
        start(message)

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò "–°–ï–ì–û–î–ù–Ø"
# ============================================================================

@bot.message_handler(func=lambda message: message.text == "üìÖ –°–µ–≥–æ–¥–Ω—è")
def handle_today(message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.
    
    –õ–æ–≥–∏–∫–∞:
        1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å
        2. –ï—Å–ª–∏ –≤—ã—Ö–æ–¥–Ω–æ–π - —Å–æ–æ–±—â–∞–µ–º
        3. –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–∫–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        4. –ï—Å–ª–∏ —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –Ω–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω—É
        5. –ï—Å–ª–∏ –µ—Å—Ç—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏ —Å—Ç–∞—Ç—É—Å–æ–º
    """
    user_id = message.chat.id
    student = Student.objects.get(telegram_id=user_id)
    
    today_num = get_current_lesson_time().isoweekday()
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–π
    if today_num > 5:
        bot.send_message(
            message.chat.id,
            "üéâ *–°–µ–≥–æ–¥–Ω—è –≤—ã—Ö–æ–¥–Ω–æ–π!* üéâ\n\n"
            "–û—Ç–¥—ã—Ö–∞–π, –Ω–∞–±–∏—Ä–∞–π—Å—è —Å–∏–ª –∏ –≥–æ—Ç–æ–≤—å—Å—è –∫ –Ω–æ–≤–æ–π —É—á–µ–±–Ω–æ–π –Ω–µ–¥–µ–ª–µ! üí™",
            parse_mode='Markdown',
            reply_markup=get_main_keyboard()
        )
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —É—Ä–æ–∫–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    lessons, lesson_type = get_student_lessons(student, today_num)
    
    # –ï—Å–ª–∏ —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç
    if not lessons:
        admin_settings = AdminSettings.objects.first()
        admin_contact = admin_settings.contact if admin_settings else "@Abumalik08"
        
        # –°–æ–∑–¥–∞—ë–º –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏
        markup = telebot.types.InlineKeyboardMarkup()
        markup.add(telebot.types.InlineKeyboardButton(
            "üìù –°–æ–∑–¥–∞—Ç—å —Å–≤–æ—ë —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ", 
            callback_data="add_personal"
        ))
        markup.add(telebot.types.InlineKeyboardButton(
            f"‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å {admin_contact}", 
            url=f"https://t.me/{admin_contact.replace('@', '')}"  # –°—Å—ã–ª–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞
        ))
        
        bot.send_message(
            message.chat.id,
            f"üì≠ *–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ*\n\n"
            f"–î–ª—è –∫–ª–∞—Å—Å–∞ *{student.grade}{student.letter}* –ø–æ–∫–∞ –Ω–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.\n\n"
            f"üîπ *–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?*\n\n"
            f"1Ô∏è‚É£ –ü–æ–ø—Ä–æ—Å–∏—Ç—å –≥–æ—Å–ø–æ–¥–∏–Ω–∞ {admin_contact} –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ –∫–ª–∞—Å—Å–∞\n"
            f"2Ô∏è‚É£ –°–æ–∑–¥–∞—Ç—å —Å–≤–æ—ë –ª–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä—è–º–æ –≤ –±–æ—Ç–µ",
            parse_mode='Markdown',
            reply_markup=markup
        )
        return
    
    # –ï—Å–ª–∏ —É—Ä–æ–∫–∏ –µ—Å—Ç—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    days = {1: "–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö", 2: "–í–¢–û–†–ù–ò–ö", 3: "–°–†–ï–î–ê", 4: "–ß–ï–¢–í–ï–†–ì", 5: "–ü–Ø–¢–ù–ò–¶–ê"}
    source = "üåç –ì–ª–æ–±–∞–ª—å–Ω–æ–µ" if lesson_type == 'global' else "üë§ –õ–∏—á–Ω–æ–µ"
    
    text = f"üìÖ *{days[today_num]}*\n"
    text += f"üìã {source} —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n"
    text += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
    
    now = get_current_lesson_time().strftime("%H:%M")
    
    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–∫–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    for lesson in lessons:
        start, end = get_lesson_time(lesson.number)
        
        if start > now:
            status = " ‚è≥"      # –ï—â—ë –Ω–µ –Ω–∞—á–∞–ª—Å—è
        elif end < now:
            status = " ‚úÖ"      # –£–∂–µ –ø—Ä–æ—à—ë–ª
        else:
            status = " üî¥"      # –ò–¥—ë—Ç —Å–µ–π—á–∞—Å
        
        text += f"*{lesson.number}. {lesson.subject}*{status}\n"
        text += f"   ‚è∞ {start} - {end}\n\n"
    
    bot.send_message(
        message.chat.id, 
        text, 
        parse_mode='Markdown', 
        reply_markup=get_main_keyboard()
    )

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò "–ó–ê–í–¢–†–ê"
# ============================================================================

@bot.message_handler(func=lambda message: message.text == "üìÜ –ó–∞–≤—Ç—Ä–∞")
def handle_tomorrow(message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞.
    
    –ü–æ—Ö–æ–∂ –Ω–∞ handle_today, –Ω–æ –¥–ª—è –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è.
    –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å: –µ—Å–ª–∏ –∑–∞–≤—Ç—Ä–∞ —Å—É–±–±–æ—Ç–∞ - –ø–µ—Ä–µ–Ω–æ—Å–∏–º –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫.
    """
    user_id = message.chat.id
    student = Student.objects.get(telegram_id=user_id)
    
    tomorrow_num = get_current_lesson_time().isoweekday() + 1
    
    # –ï—Å–ª–∏ –∑–∞–≤—Ç—Ä–∞ —Å—É–±–±–æ—Ç–∞
    if tomorrow_num == 6:
        bot.send_message(
            message.chat.id,
            "üéâ *–ó–∞–≤—Ç—Ä–∞ —Å—É–±–±–æ—Ç–∞ - –≤—ã—Ö–æ–¥–Ω–æ–π!* üéâ\n\n"
            "–ü–ª–∞–Ω–∏—Ä—É–π —Å–≤–æ–∏ –≤—ã—Ö–æ–¥–Ω—ã–µ –∏ –æ—Ç–¥—ã—Ö–∞–π! üåü",
            parse_mode='Markdown',
            reply_markup=get_main_keyboard()
        )
        return
    
    # –ï—Å–ª–∏ –∑–∞–≤—Ç—Ä–∞ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (7) - –ø–µ—Ä–µ–Ω–æ—Å–∏–º –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ (1)
    if tomorrow_num == 7:
        tomorrow_num = 1
    
    lessons, lesson_type = get_student_lessons(student, tomorrow_num)
    
    if not lessons:
        bot.send_message(
            message.chat.id,
            "üì≠ *–ù–∞ –∑–∞–≤—Ç—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç*",
            parse_mode='Markdown',
            reply_markup=get_main_keyboard()
        )
        return
    
    days = {1: "–ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö", 2: "–í–¢–û–†–ù–ò–ö", 3: "–°–†–ï–î–ê", 4: "–ß–ï–¢–í–ï–†–ì", 5: "–ü–Ø–¢–ù–ò–¶–ê"}
    source = "üåç –ì–ª–æ–±–∞–ª—å–Ω–æ–µ" if lesson_type == 'global' else "üë§ –õ–∏—á–Ω–æ–µ"
    
    text = f"üìÜ *{days[tomorrow_num]} (–∑–∞–≤—Ç—Ä–∞)*\n"
    text += f"üìã {source} —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n"
    text += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
    
    for lesson in lessons:
        start, end = get_lesson_time(lesson.number)
        text += f"*{lesson.number}. {lesson.subject}*\n"
        text += f"   ‚è∞ {start} - {end}\n\n"
    
    bot.send_message(
        message.chat.id, 
        text, 
        parse_mode='Markdown', 
        reply_markup=get_main_keyboard()
    )

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò "–ù–ï–î–ï–õ–Ø"
# ============================================================================

@bot.message_handler(func=lambda message: message.text == "üìö –ù–µ–¥–µ–ª—è")
def handle_week(message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –≤—Å—é –Ω–µ–¥–µ–ª—é (–ø–Ω-–ø—Ç).
    """
    user_id = message.chat.id
    student = Student.objects.get(telegram_id=user_id)
    
    days = {1: "–ü–ù", 2: "–í–¢", 3: "–°–†", 4: "–ß–¢", 5: "–ü–¢"}
    source = "üåç –ì–ª–æ–±–∞–ª—å–Ω–æ–µ" if student.use_global else "üë§ –õ–∏—á–Ω–æ–µ"
    
    text = f"üìö *–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é*\n"
    text += f"üìã {source} —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ\n"
    text += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    
    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ (1-5)
    for day_num in range(1, 6):
        lessons, _ = get_student_lessons(student, day_num)
        text += f"\n*{days[day_num]}:*\n"
        
        if lessons:
            subjects = []
            for lesson in lessons:
                start, _ = get_lesson_time(lesson.number)
                subjects.append(f"{lesson.number}.{lesson.subject} ({start})")
            text += " | ".join(subjects)
        else:
            text += "_–Ω–µ—Ç —É—Ä–æ–∫–æ–≤_"
        
        text += "\n"
    
    bot.send_message(
        message.chat.id, 
        text, 
        parse_mode='Markdown', 
        reply_markup=get_main_keyboard()
    )

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò "–°–õ–ï–î–£–Æ–©–ò–ô –£–†–û–ö"
# ============================================================================

@bot.message_handler(func=lambda message: message.text == "‚è∞ –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫")
def next_lesson_command(message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫ –∏ —Å–∫–æ–ª—å–∫–æ –¥–æ –Ω–µ–≥–æ –æ—Å—Ç–∞–ª–æ—Å—å.
    """
    user_id = message.chat.id
    student = Student.objects.get(telegram_id=user_id)
    
    now = get_current_lesson_time()
    next_lesson, next_time = get_next_lesson(student, now)
    
    if next_lesson:
        start, end = get_lesson_time(next_lesson.number)
        
        # –í—ã—á–∏—Å–ª—è–µ–º —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –æ—Å—Ç–∞–ª–æ—Å—å
        time_until = datetime.strptime(next_time, "%H:%M") - datetime.strptime(now.strftime("%H:%M"), "%H:%M")
        minutes_until = int(time_until.total_seconds() / 60)
        
        text = (
            f"‚è∞ *–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫*\n\n"
            f"üìö *{next_lesson.subject}*\n"
            f"üî¢ –£—Ä–æ–∫ ‚Ññ{next_lesson.number}\n"
            f"‚è±Ô∏è {start} - {end}\n"
            f"‚åõÔ∏è –î–æ –Ω–∞—á–∞–ª–∞: {minutes_until} –º–∏–Ω.\n"
        )
        
        # –ï—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω—å—à–µ REMINDER_MINUTES - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
        if minutes_until <= REMINDER_MINUTES:
            text += f"\n‚ö†Ô∏è *–£—Ä–æ–∫ –Ω–∞—á–Ω—ë—Ç—Å—è —Å–æ–≤—Å–µ–º —Å–∫–æ—Ä–æ!*"
    else:
        if now.isoweekday() > 5:
            text = "üéâ *–°–µ–≥–æ–¥–Ω—è –≤—ã—Ö–æ–¥–Ω–æ–π!*"
        else:
            text = "‚ú® *–ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å–µ —É—Ä–æ–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å*"
    
    bot.send_message(
        message.chat.id, 
        text, 
        parse_mode='Markdown', 
        reply_markup=get_main_keyboard()
    )

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò "–ù–ê–°–¢–†–û–ô–ö–ò"
# ============================================================================

@bot.message_handler(func=lambda message: message.text == "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
def handle_settings(message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–µ–∫—É—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö.
    """
    user_id = message.chat.id
    student = Student.objects.get(telegram_id=user_id)
    
    text = (
        f"‚öôÔ∏è *–ù–ê–°–¢–†–û–ô–ö–ò*\n\n"
        f"üë§ *–ò–º—è:* {student.name}\n"
        f"üéì *–ö–ª–∞—Å—Å:* {student.grade}{student.letter}\n"
        f"üìã *–¢–∏–ø:* {'üåç –ì–ª–æ–±–∞–ª—å–Ω–æ–µ' if student.use_global else 'üë§ –õ–∏—á–Ω–æ–µ'}\n\n"
        f"*–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:*"
    )
    
    bot.send_message(
        message.chat.id,
        text,
        parse_mode='Markdown',
        reply_markup=get_settings_keyboard(student)
    )

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò "–°–ú–ï–ù–ò–¢–¨ –ö–õ–ê–°–°"
# ============================================================================

@bot.message_handler(func=lambda message: message.text == "üîÑ –°–º–µ–Ω–∏—Ç—å –∫–ª–∞—Å—Å")
def change_class(message):
    """
    –ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Å–º–µ–Ω—ã –∫–ª–∞—Å—Å–∞.
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤—ã–±–æ—Ä–æ–º –∫–ª–∞—Å—Å–∞ (1-11).
    """
    markup = telebot.types.InlineKeyboardMarkup(row_width=4)
    for g in range(1, 12):
        markup.add(telebot.types.InlineKeyboardButton(
            str(g), 
            callback_data=f"grade_{g}"
        ))
    
    bot.send_message(
        message.chat.id,
        "üîÑ *–°–º–µ–Ω–∞ –∫–ª–∞—Å—Å–∞*\n\n"
        "üìö –í—ã–±–µ—Ä–∏ —Å–≤–æ–π –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å:",
        parse_mode='Markdown',
        reply_markup=markup
    )

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò "–¢–ò–ü –†–ê–°–ü–ò–°–ê–ù–ò–Ø"
# ============================================================================

@bot.message_handler(func=lambda message: message.text == "üìã –¢–∏–ø —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è")
def change_schedule_type(message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.
    """
    user_id = message.chat.id
    student = Student.objects.get(telegram_id=user_id)
    
    markup = telebot.types.InlineKeyboardMarkup(row_width=1)
    
    # –û—Ç–º–µ—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –≥–∞–ª–æ—á–∫–æ–π
    global_text = "‚úÖ –ì–ª–æ–±–∞–ª—å–Ω–æ–µ" if student.use_global else "üåç –ì–ª–æ–±–∞–ª—å–Ω–æ–µ"
    personal_text = "‚úÖ –õ–∏—á–Ω–æ–µ" if not student.use_global else "üë§ –õ–∏—á–Ω–æ–µ"
    
    markup.add(
        telebot.types.InlineKeyboardButton(global_text, callback_data="use_global"),
        telebot.types.InlineKeyboardButton(personal_text, callback_data="use_personal"),
        telebot.types.InlineKeyboardButton("üìù –°–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ–µ", callback_data="add_personal")
    )
    
    bot.send_message(
        message.chat.id,
        f"üìã *–¢–∏–ø —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è*\n\n"
        f"üåç *–ì–ª–æ–±–∞–ª—å–Ω–æ–µ* - –æ–±—â–µ–µ –¥–ª—è –≤—Å–µ–≥–æ –∫–ª–∞—Å—Å–∞\n"
        f"üë§ *–õ–∏—á–Ω–æ–µ* - —Ç–≤–æ—ë –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ\n\n"
        f"–í—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—ã–π:",
        parse_mode='Markdown',
        reply_markup=markup
    )

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò "–ò–ù–§–û–†–ú–ê–¶–ò–Ø"
# ============================================================================

@bot.message_handler(func=lambda message: message.text == "‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")
def handle_info(message):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–æ—Ç–µ (–ø—Ä–æ—Å—Ç–æ–π –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π).
    """
    markup = telebot.types.InlineKeyboardMarkup(row_width=1)
    markup.add(
        telebot.types.InlineKeyboardButton("üìñ –û –±–æ—Ç–µ", callback_data="about_simple"),
        telebot.types.InlineKeyboardButton("üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data="about_tech")
    )
    
    bot.send_message(
        message.chat.id,
        "‚ÑπÔ∏è *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è*\n\n"
        "–í—ã–±–µ—Ä–∏, —á—Ç–æ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å:",
        parse_mode='Markdown',
        reply_markup=markup
    )

# ============================================================================
# –û–ë–†–ê–ë–û–¢–ß–ò–ö –ò–ù–õ–ê–ô–ù-–ö–ù–û–ü–û–ö (callback)
# ============================================================================

@bot.callback_query_handler(func=lambda call: True)
def handle_callback(call):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏.
    
    call.data —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫—É –∏–∑ callback_data, –∫–æ—Ç–æ—Ä—É—é –º—ã –∑–∞–¥–∞–≤–∞–ª–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–Ω–æ–ø–∫–∏.
    
    –í–æ–∑–º–æ–∂–Ω—ã–µ callback_data:
        - grade_5      - –≤—ã–±–æ—Ä –∫–ª–∞—Å—Å–∞
        - letter_–ê     - –≤—ã–±–æ—Ä –±—É–∫–≤—ã
        - use_global   - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ
        - use_personal - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –ª–∏—á–Ω–æ–µ
        - add_personal - —Å–æ–∑–¥–∞—Ç—å –ª–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        - about_simple - –ø—Ä–æ—Å—Ç–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        - about_tech   - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    """
    user_id = call.message.chat.id
    student = Student.objects.get(telegram_id=user_id)
    
    # ===== –í–´–ë–û–† –ö–õ–ê–°–°–ê =====
    if call.data.startswith('grade_'):
        grade = int(call.data.split('_')[1])
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        temp_data[user_id] = {'grade': grade}
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å –±—É–∫–≤–∞–º–∏
        markup = telebot.types.InlineKeyboardMarkup(row_width=4)
        for letter in ['–ê', '–ë', '–í', '–ì']:
            markup.add(telebot.types.InlineKeyboardButton(
                letter, 
                callback_data=f"letter_{letter}"
            ))
        
        bot.edit_message_text(
            f"üìö *–ö–ª–∞—Å—Å {grade}*\n\n"
            f"–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ –±—É–∫–≤—É:",
            call.message.chat.id,
            call.message.message_id,
            parse_mode='Markdown',
            reply_markup=markup
        )
    
    # ===== –í–´–ë–û–† –ë–£–ö–í–´ =====
    elif call.data.startswith('letter_'):
        letter = call.data.split('_')[1]
        grade = temp_data[user_id]['grade']
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∞—Å—Å –∏ –±—É–∫–≤—É –≤ –±–∞–∑—É
        student.grade = grade
        student.letter = letter
        student.save()
        
        bot.edit_message_text(
            f"‚úÖ *–ö–ª–∞—Å—Å —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!*\n\n"
            f"üìö –¢–≤–æ–π –∫–ª–∞—Å—Å: *{grade}{letter}*",
            call.message.chat.id,
            call.message.message_id,
            parse_mode='Markdown'
        )
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        show_main_menu(call.message, student)
        del temp_data[user_id]  # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    
    # ===== –ü–ï–†–ï–ö–õ–Æ–ß–ò–¢–¨ –ù–ê –ì–õ–û–ë–ê–õ–¨–ù–û–ï =====
    elif call.data == 'use_global':
        student.use_global = True
        student.save()
        
        bot.answer_callback_query(call.id, "‚úÖ –í–∫–ª—é—á–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ")
        bot.edit_message_text(
            "‚úÖ *–ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!*\n\n"
            "
